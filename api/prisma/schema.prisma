generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Users (synced with Supabase Auth)
model User {
  id               String   @id @db.Uuid // matches Supabase auth.users.id
  email            String   @unique @db.VarChar(255)
  name             String?  @db.VarChar(255)
  avatarUrl        String?  @map("avatar_url")
  plan             String   @default("free") @db.VarChar(20)
  stripeCustomerId String?  @unique @map("stripe_customer_id") @db.VarChar(255)
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @default(now()) @updatedAt @map("updated_at")

  preferences   UserPreferences?
  interactions  UserInteraction[]
  conversations Conversation[]
  clicks        AffiliateClick[]
  subscription  Subscription?
  usageTracking UsageTracking[]

  @@map("users")
}

model UserPreferences {
  userId            String   @id @map("user_id") @db.Uuid
  categories        String[] @default([])
  budgetMin         Int      @default(0) @map("budget_min")
  budgetMax         Int      @default(1000) @map("budget_max")
  currency          String   @default("USD") @db.VarChar(3)
  qualityPreference String   @default("mid-range") @map("quality_preference") @db.VarChar(20)
  brandPreferences  String[] @default([]) @map("brand_preferences")
  brandExclusions   String[] @default([]) @map("brand_exclusions")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

model UserInteraction {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String   @map("user_id") @db.Uuid
  productId       String?  @map("product_id") @db.Uuid
  interactionType String   @map("interaction_type") @db.VarChar(50)
  context         Json?
  createdAt       DateTime @default(now()) @map("created_at")

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id])

  @@index([userId])
  @@index([productId])
  @@map("user_interactions")
}

// Products
model Product {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  externalId    String?   @map("external_id") @db.VarChar(255)
  retailer      String    @db.VarChar(100)
  name          String    @db.VarChar(500)
  description   String?
  imageUrl      String?   @map("image_url")
  category      String?   @db.VarChar(100)
  brand         String?   @db.VarChar(255)
  currentPrice  Decimal?  @map("current_price") @db.Decimal(10, 2)
  currency      String    @default("USD") @db.VarChar(3)
  affiliateUrl  String?   @map("affiliate_url")
  metadata      Json?
  lastScrapedAt DateTime? @map("last_scraped_at")
  createdAt     DateTime  @default(now()) @map("created_at")

  rating           ProductRating?
  reviewSources    ReviewSource[]
  interactions     UserInteraction[]
  clicks           AffiliateClick[]
  sponsoredProduct SponsoredProduct?

  @@unique([externalId, retailer])
  @@index([category])
  @@index([retailer])
  @@map("products")
}

model ProductRating {
  productId        String   @id @map("product_id") @db.Uuid
  aiRating         Int?     @map("ai_rating")
  confidence       Decimal? @db.Decimal(3, 2)
  sentimentScore   Decimal? @map("sentiment_score") @db.Decimal(3, 2)
  reliabilityScore Decimal? @map("reliability_score") @db.Decimal(3, 2)
  valueScore       Decimal? @map("value_score") @db.Decimal(3, 2)
  popularityScore  Decimal? @map("popularity_score") @db.Decimal(3, 2)
  sourcesAnalyzed  Int      @default(0) @map("sources_analyzed")
  pros             String[] @default([])
  cons             String[] @default([])
  summary          String?
  calculatedAt     DateTime @default(now()) @map("calculated_at")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_ratings")
}

model ReviewSource {
  id                 String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId          String   @map("product_id") @db.Uuid
  sourceType         String   @map("source_type") @db.VarChar(50)
  sourceUrl          String   @unique @map("source_url")
  sourceName         String?  @map("source_name") @db.VarChar(255)
  rawContent         String?  @map("raw_content")
  extractedSentiment Decimal? @map("extracted_sentiment") @db.Decimal(3, 2)
  extractedPros      String[] @default([]) @map("extracted_pros")
  extractedCons      String[] @default([]) @map("extracted_cons")
  upvotes            Int?
  commentCount       Int?     @map("comment_count")
  scrapedAt          DateTime @default(now()) @map("scraped_at")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("review_sources")
}

// Conversations
model Conversation {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  title       String   @default("New Chat") @db.VarChar(255)
  pageContext Json?    @map("page_context")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages Message[]

  @@index([userId])
  @@map("conversations")
}

model Message {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  conversationId String   @map("conversation_id") @db.Uuid
  role           String   @db.VarChar(20)
  content        String
  productsShown  String[] @default([]) @map("products_shown") @db.Uuid
  metadata       Json?
  createdAt      DateTime @default(now()) @map("created_at")

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@map("messages")
}

// Monetization
model AffiliateClick {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId           String?  @map("user_id") @db.Uuid
  productId        String?  @map("product_id") @db.Uuid
  affiliateNetwork String?  @map("affiliate_network") @db.VarChar(50)
  clickUrl         String?  @map("click_url")
  createdAt        DateTime @default(now()) @map("created_at")

  user    User?    @relation(fields: [userId], references: [id])
  product Product? @relation(fields: [productId], references: [id])

  @@index([userId])
  @@map("affiliate_clicks")
}

model SponsoredProduct {
  id                  String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId           String    @unique @map("product_id") @db.Uuid
  campaignName        String?   @map("campaign_name") @db.VarChar(255)
  bidAmount           Decimal?  @map("bid_amount") @db.Decimal(10, 4)
  dailyBudget         Decimal?  @map("daily_budget") @db.Decimal(10, 2)
  spent               Decimal   @default(0) @db.Decimal(10, 2)
  targetingCategories String[]  @default([]) @map("targeting_categories")
  isActive            Boolean   @default(true) @map("is_active")
  createdAt           DateTime  @default(now()) @map("created_at")

  product Product @relation(fields: [productId], references: [id])

  impressions AdImpression[]

  @@map("sponsored_products")
}

model AdImpression {
  id                 String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sponsoredProductId String   @map("sponsored_product_id") @db.Uuid
  userId             String?  @map("user_id") @db.Uuid
  placement          String?  @db.VarChar(50)
  createdAt          DateTime @default(now()) @map("created_at")

  sponsoredProduct SponsoredProduct @relation(fields: [sponsoredProductId], references: [id])

  @@map("ad_impressions")
}

model Subscription {
  id                   String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId               String   @unique @map("user_id") @db.Uuid
  stripeSubscriptionId String   @unique @map("stripe_subscription_id") @db.VarChar(255)
  plan                 String   @db.VarChar(50)
  status               String   @db.VarChar(50)
  currentPeriodEnd     DateTime @map("current_period_end")
  createdAt            DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@map("subscriptions")
}

model UsageTracking {
  userId      String   @map("user_id") @db.Uuid
  date        DateTime @db.Date
  searchCount Int      @default(0) @map("search_count")

  user User @relation(fields: [userId], references: [id])

  @@id([userId, date])
  @@map("usage_tracking")
}
